<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Solving N+1 Problem in Hibernate | Ankush Choubey</title>
<meta name="generator" content="Jekyll v4.1.1">
<meta property="og:title" content="Solving N+1 Problem in Hibernate">
<meta property="og:locale" content="en_US">
<meta name="description" content="Speed up fetching of child entities">
<meta property="og:description" content="Speed up fetching of child entities">
<link rel="canonical" href="https://www.ankushchoubey.com/n-plus-one-hibernate/">
<meta property="og:url" content="https://www.ankushchoubey.com/n-plus-one-hibernate/">
<meta property="og:site_name" content="Ankush Choubey">
<meta property="og:image" content="https://www.ankushchoubey.com/images/n-plus-one.svg">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2021-07-15T00:00:00-05:00">
<meta name="twitter:card" content="summary_large_image">
<meta property="twitter:image" content="https://www.ankushchoubey.com/images/n-plus-one.svg">
<meta property="twitter:title" content="Solving N+1 Problem in Hibernate">
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2021-08-01T15:52:08-05:00","datePublished":"2021-07-15T00:00:00-05:00","description":"Speed up fetching of child entities","headline":"Solving N+1 Problem in Hibernate","image":"https://www.ankushchoubey.com/images/n-plus-one.svg","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.ankushchoubey.com/n-plus-one-hibernate/"},"url":"https://www.ankushchoubey.com/n-plus-one-hibernate/"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css">
<link type="application/atom+xml" rel="alternate" href="https://www.ankushchoubey.com/feed.xml" title="Ankush Choubey">
<!-- the google_analytics_id gets auto inserted from the config file -->



<script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-35993343-1','auto');ga('require','displayfeatures');ga('send','pageview');</script>

<link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico">
<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Solving N+1 Problem in Hibernate | Ankush Choubey</title>
<meta name="generator" content="Jekyll v4.1.1">
<meta property="og:title" content="Solving N+1 Problem in Hibernate">
<meta property="og:locale" content="en_US">
<meta name="description" content="Speed up fetching of child entities">
<meta property="og:description" content="Speed up fetching of child entities">
<link rel="canonical" href="https://www.ankushchoubey.com/n-plus-one-hibernate/">
<meta property="og:url" content="https://www.ankushchoubey.com/n-plus-one-hibernate/">
<meta property="og:site_name" content="Ankush Choubey">
<meta property="og:image" content="https://www.ankushchoubey.com/images/n-plus-one.svg">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2021-07-15T00:00:00-05:00">
<meta name="twitter:card" content="summary_large_image">
<meta property="twitter:image" content="https://www.ankushchoubey.com/images/n-plus-one.svg">
<meta property="twitter:title" content="Solving N+1 Problem in Hibernate">
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2021-08-01T15:52:08-05:00","datePublished":"2021-07-15T00:00:00-05:00","description":"Speed up fetching of child entities","headline":"Solving N+1 Problem in Hibernate","image":"https://www.ankushchoubey.com/images/n-plus-one.svg","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.ankushchoubey.com/n-plus-one-hibernate/"},"url":"https://www.ankushchoubey.com/n-plus-one-hibernate/"}</script>
<!-- End Jekyll SEO tag -->

<link href="https://unpkg.com/@primer/css/dist/primer.css" rel="stylesheet">
<link rel="stylesheet" href="//use.fontawesome.com/releases/v5.0.7/css/all.css">
<link type="application/atom+xml" rel="alternate" href="https://www.ankushchoubey.com/feed.xml" title="Ankush Choubey">
<!-- the google_analytics_id gets auto inserted from the config file -->



<script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-35993343-1','auto');ga('require','displayfeatures');ga('send','pageview');</script>


    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css" integrity="sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/+DiW/UqRcLbRjq" crossorigin="anonymous">
    <script type="text/javascript" async src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML"> </script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js" integrity="sha384-y23I5Q6l+B6vatafAwxRu/0oK/79VlbSz7Q9aiSZUvyWYIYsd+qj+o24G5ZU2zJz" crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js" integrity="sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI" crossorigin="anonymous"></script>
    <script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement( document.body, {
        delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "[%", right: "%]", display: true},
            {left: "$", right: "$", display: false}
        ]}
        );
    });
    </script>


<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head>
<body>
<header class="site-header">

  <div class="wrapper">
<a class="site-title" rel="author" href="/">Ankush Choubey</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger">
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewbox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"></path>
            </svg>
          </span>
        </label>

        <div class="trigger">
<a class="page-link" href="/core-values-page/">Core Values</a><a class="page-link" href="/philosophy/">Philosophy</a><a class="page-link" href="/resume">Hire me!</a><a class="page-link" href="/search/">Search</a>
</div>
      </nav>
</div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <style>
  .page-content{
    padding-top: 0px;
  }
  .post-header{
    display: flex;
    flex-direction: column;
    justify-content: end;height: 300px;}

  .cover-image{
    position: absolute;
    left:0px;
    height: 300px;
    object-fit: cover;
    width: 100%;
  }

  @media screen and (max-width: 500px) {
    .post-header{height: 550px;}
    .cover-image{
      height: 550px;
    }
  }
  .post-header-content{backdrop-filter: blur(200px); 
    padding: 0px 20px;
    -webkit-backdrop-filter: blur(200px);
        background: #ffffffcf;}
</style>

<header class="post-header"><img src="/images/n-plus-one.svg" class="cover-image"><div class="post-header-content">
    <h1 class="post-title p-name" itemprop="name headline">Solving N+1 Problem in Hibernate</h1>
<p class="page-description">Speed up fetching of child entities</p>
<p class="post-meta post-meta-title"><time class="dt-published" datetime="2021-07-15T00:00:00-05:00" itemprop="datePublished">
        Jul 15, 2021
      </time>
      • <span class="read-time" title="Estimated read time">
    
    
      2 min read
    
</span></p>

    
    <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i>
      
      <a class="category-tags-link" href="/categories/#spring-boot">spring-boot</a>
       
      
      <a class="category-tags-link" href="/categories/#database">database</a>
      
      
    </p>
    

    </div>
</header>
<article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <div class="post-content e-content" itemprop="articleBody">
    <h2 id="n1-problem">N+1 Problem</h2>

<p>If you are working with JPA entities and you have joins. Then you might have faced this problem.</p>

<p>If you have something like <code class="language-plaintext highlighter-rouge">@OneToMany</code> mapping between a parent and a child and fetch parent. All the child entities will be fetch one by one is a kind of a loop.</p>

<p>You can check this behavior by using the following <code class="language-plaintext highlighter-rouge">application.properties</code> and then checking logs.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>spring.jpa.properties.hibernate.show_sql=true
spring.jpa.properties.hibernate.use_sql_comments=true
spring.jpa.properties.hibernate.format_sql=true
</code></pre></div></div>

<p>So if you have 2 records for parent and 4 corresponding child records.</p>

<p>A total of 2*8 separate queries wil be run.</p>

<p><img src="/images/n-plus-one.svg" alt=""></p>

<table>
  <thead>
    <tr>
      <th>Query Number</th>
      <th>Purpose</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>1</td>
      <td>Fetch Parent Entity: id_1</td>
    </tr>
    <tr>
      <td>2</td>
      <td>Fetch Child Associated with parent id_1: id_a</td>
    </tr>
    <tr>
      <td>3</td>
      <td>Fetch Child Associated with parent id_1: id_b</td>
    </tr>
    <tr>
      <td>4</td>
      <td>Fetch Child Associated with parent id_1: id_c</td>
    </tr>
    <tr>
      <td>5</td>
      <td>Fetch Parent Entity: id_2</td>
    </tr>
    <tr>
      <td>6</td>
      <td>Fetch Child Associated with parent id_1: id_d</td>
    </tr>
    <tr>
      <td>7</td>
      <td>Fetch Child Associated with parent id_1: id_e</td>
    </tr>
    <tr>
      <td>8</td>
      <td>Fetch Child Associated with parent id_1: id_f</td>
    </tr>
  </tbody>
</table>

<p>If similarly you have a 1000 records and 10 corresponding child records.</p>

<p>Then 1000*10 = 10,000 queries will be run.</p>

<p>This is inefficient.</p>

<p>We need some way to reduce the number of query calls. Even if the amount of data is the same, the cost of running more queries is much higher that getting the same amout of work done with less number of queries.</p>

<h2 id="fetchmodes">FetchModes</h2>

<p>FetchModes allow you to say to Hibernate to fetch all childrens at once instead of fetching them one at the time.</p>

<p>FetchMode is different from FetchType.EAGER or LAZY. The former is used to decides where to fetch children along with parent or later when needed.</p>

<h3 id="fetchmodejoin">FetchMode.JOIN</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nd">@Fetch</span><span class="o">(</span><span class="nc">FetchMode</span><span class="o">.</span><span class="na">JOIN</span><span class="o">)</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">EntityType</span><span class="o">&gt;</span> <span class="n">entityName</span><span class="o">;</span>
</code></pre></div></div>

<p>One a single query will be run.</p>

<p>If you are using this, all data will be fetch at once using join but the payload size will be huge.</p>

<h3 id="fetchmodesubselect">FetchMode.SUBSELECT</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nd">@Fetch</span><span class="o">(</span><span class="nc">FetchMode</span><span class="o">.</span><span class="na">SUBSELECT</span><span class="o">)</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">EntityType</span><span class="o">&gt;</span> <span class="n">entityName</span><span class="o">;</span>
</code></pre></div></div>

<p>If used a minimum of 2 queries will be run.</p>

<ul>
  <li>One for parent @Entity</li>
  <li>One for for each child @Entity type will be run. After the query is run all chilren of particular type will be fetched.</li>
</ul>

<p>FetchMode.SUBSELECT is also seems to better when used to FetchType.LAZY. Here, all parent entities will be fetched first. When child entities are needed, all child entities will be fetched at once instead of multiple queries.</p>

  </div>
<!-- from https://github.com/utterance/utterances -->
<script src="https://utteranc.es/client.js" repo="ankschoubey/blog" issue-term="title" label="blogpost-comment" theme="github-light" crossorigin="anonymous" async>
</script><div id="disqus_thread"></div>
  <script>
    var disqus_config = function () {
      this.page.url = 'https://www.ankushchoubey.com/n-plus-one-hibernate/';
      this.page.identifier = 'https://www.ankushchoubey.com/n-plus-one-hibernate/';
    };

    (function() {
      var d = document, s = d.createElement('script');

      s.src = 'https://ankushchoubey.disqus.com/embed.js';

      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a>
</noscript>
<a class="u-url" href="/n-plus-one-hibernate/" hidden></a>
</article>
      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="https://www.ankushchoubey.com/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>Full Stack Developer - Cloud/Microservices</p>
      </div>
    </div>

    <div class="social-links">
<ul class="social-media-list">
<li>
  <a rel="me" href="https://github.com/ankschoubey" target="_blank" title="github">
    <svg class="svg-icon grey">
      <use xlink:href="/assets/minima-social-icons.svg#github"></use>
    </svg>
  </a>
</li>
<li>
  <a rel="me" href="https://twitter.com/ankschoubey" target="_blank" title="twitter">
    <svg class="svg-icon grey">
      <use xlink:href="/assets/minima-social-icons.svg#twitter"></use>
    </svg>
  </a>
</li>
</ul>
</div>

  </div>

</footer>
</body>

</html>
