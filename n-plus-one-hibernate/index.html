<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/REC-html40/loose.dtd">
<!-- <script>
  for (const iterator of document.getElementsByClassName('page-link')) {
      if (iterator.innerHTML === 'Search'){ iterator.classList.add('search-button'); iterator.title = 'Search';}
      if (iterator.innerHTML === 'Tags'){ iterator.classList.add('tags-button'); iterator.title = 'Tags';}
      if (iterator.innerHTML === 'Side Projects'){ iterator.classList.add('side-project-button'); iterator.title = 'Side Projects';}
  }
</script> --><html><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<script type="text/javascript" src="/assets/accordian.js"></script>

<article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Solving N+1 Problem in Hibernate</h1>

    <p class="page-description">Speed up fetching of child entities</p>
<p class="post-meta post-meta-title"><time class="dt-published post-meta-created-date" datetime="2021-07-15T00:00:00-05:00" itemprop="datePublished">
        Written: Jul 15, 2021
      </time>~<time class="dt-modified post-meta-last-modified-date" datetime="2021-08-01T15:52:08-05:00" itemprop="dateModified">
          Updated: Aug 1, 2021
        </time>
       • <span class="read-time" title="Estimated read time">
    
    
      2 min read
    
</span></p>    <style>
        .post-tool-bar{
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0px 10px 0px;
            /* border: 1px solid #e8e8e8; */
            border-width: 0px 0px 1px 0px;
        }
        .left-section , .right-section{
            display: flex;
            gap: 8px;
        }

    </style>
    
    <div class="post-tool-bar">
<!-- <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
<script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
<script>
        AOS.init();
</script> -->

<div class="tag-list">
    
    <a class="tag fa fa-hashtag spring-boot" href="/categories/#spring-boot">spring-boot</a>
    
    <a class="tag fa fa-hashtag database" href="/categories/#database">database</a>
    
</div>
<div class="right-section">
<a id="translate-btn" href="https://www.translatetheweb.com/?ref=TAns&from=&to=hi&a=https%3A%2F%2Fwww.ankushchoubey.com%2F">
    <img src="/images/icons/translate.svg" alt="Translate" style="width:35px">
</a>


<script>
    a = document.getElementById('translate-btn');
    a.setAttribute("href", "https://www.translatetheweb.com/?ref=TAns&from=&to=hi&a=" + window.location.href);
</script><a id="speech-btn">
    <img src="/images/icons/ear.svg" alt="listen" style="width:35px; cursor: pointer;">
</a>

<script>
    speakPost = () => {
        var msg = new SpeechSynthesisUtterance();
        const title = document.querySelector("h1.post-title.p-name").innerText;
        const post = document.querySelector("div.post-content.e-content").innerText
        msg.text = title + '.' + post;
        window.speechSynthesis.speak(msg);
    }
    if ('speechSynthesis' in window) {
        document.getElementById("speech-btn").addEventListener("click", speakPost);
    } else {
        document.getElementById('speech-btn').style.display = 'none';
    }
</script>

<!-- https://www.alebalweb-blog.com/85-text-to-speech-player-with-buttons-play-pause-stop-and-voice-choice.html -->
</div>
      
          
    </div>
    
</header>

  <div class="post-content e-content" itemprop="articleBody">
    <h2 id="n1-problem">N+1 Problem</h2>

<p>If you are working with JPA entities and you have joins. Then you might have faced this problem.</p>

<p>If you have something like <code class="language-plaintext highlighter-rouge">@OneToMany</code> mapping between a parent and a child and fetch parent. All the child entities will be fetch one by one is a kind of a loop.</p>

<p>You can check this behavior by using the following <code class="language-plaintext highlighter-rouge">application.properties</code> and then checking logs.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>spring.jpa.properties.hibernate.show_sql=true
spring.jpa.properties.hibernate.use_sql_comments=true
spring.jpa.properties.hibernate.format_sql=true
</code></pre></div></div>

<p>So if you have 2 records for parent and 4 corresponding child records.</p>

<p>A total of 2*8 separate queries wil be run.</p>

<p><img src="/images/n-plus-one.svg" alt=""></p>

<table>
  <thead>
    <tr>
      <th>Query Number</th>
      <th>Purpose</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>1</td>
      <td>Fetch Parent Entity: id_1</td>
    </tr>
    <tr>
      <td>2</td>
      <td>Fetch Child Associated with parent id_1: id_a</td>
    </tr>
    <tr>
      <td>3</td>
      <td>Fetch Child Associated with parent id_1: id_b</td>
    </tr>
    <tr>
      <td>4</td>
      <td>Fetch Child Associated with parent id_1: id_c</td>
    </tr>
    <tr>
      <td>5</td>
      <td>Fetch Parent Entity: id_2</td>
    </tr>
    <tr>
      <td>6</td>
      <td>Fetch Child Associated with parent id_1: id_d</td>
    </tr>
    <tr>
      <td>7</td>
      <td>Fetch Child Associated with parent id_1: id_e</td>
    </tr>
    <tr>
      <td>8</td>
      <td>Fetch Child Associated with parent id_1: id_f</td>
    </tr>
  </tbody>
</table>

<p>If similarly you have a 1000 records and 10 corresponding child records.</p>

<p>Then 1000*10 = 10,000 queries will be run.</p>

<p>This is inefficient.</p>

<p>We need some way to reduce the number of query calls. Even if the amount of data is the same, the cost of running more queries is much higher that getting the same amout of work done with less number of queries.</p>

<h2 id="fetchmodes">FetchModes</h2>

<p>FetchModes allow you to say to Hibernate to fetch all childrens at once instead of fetching them one at the time.</p>

<p>FetchMode is different from FetchType.EAGER or LAZY. The former is used to decides where to fetch children along with parent or later when needed.</p>

<h3 id="fetchmodejoin">FetchMode.JOIN</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nd">@Fetch</span><span class="o">(</span><span class="nc">FetchMode</span><span class="o">.</span><span class="na">JOIN</span><span class="o">)</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">EntityType</span><span class="o">&gt;</span> <span class="n">entityName</span><span class="o">;</span>
</code></pre></div></div>

<p>One a single query will be run.</p>

<p>If you are using this, all data will be fetch at once using join but the payload size will be huge.</p>

<h3 id="fetchmodesubselect">FetchMode.SUBSELECT</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nd">@Fetch</span><span class="o">(</span><span class="nc">FetchMode</span><span class="o">.</span><span class="na">SUBSELECT</span><span class="o">)</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">EntityType</span><span class="o">&gt;</span> <span class="n">entityName</span><span class="o">;</span>
</code></pre></div></div>

<p>If used a minimum of 2 queries will be run.</p>

<ul>
  <li>One for parent @Entity</li>
  <li>One for for each child @Entity type will be run. After the query is run all chilren of particular type will be fetched.</li>
</ul>

<p>FetchMode.SUBSELECT is also seems to better when used to FetchType.LAZY. Here, all parent entities will be fetched first. When child entities are needed, all child entities will be fetched at once instead of multiple queries.</p>

  </div>
  <!-- https://david.elbe.me/jekyll/2015/06/20/how-to-link-to-next-and-previous-post-with-jekyll.html -->

<div class="PageNavigation">
    
      <a class="prev" href="/first-program/">« My First Program</a>
    
    
      <a class="next" href="/package-json/">Tips for working with `package.json` »</a>
    
  </div>

<style>
    .PageNavigation {
  font-size: 14px;
  display: block;
  width: auto;
  overflow: hidden;
}

.PageNavigation a {
  display: block;
  width: 50%;
  float: left;
  margin: 1em 0;
}

.PageNavigation .next {
  text-align: right;
}
</style>
<!-- from https://github.com/utterance/utterances -->
<!-- <script src="https://utteranc.es/client.js"
        repo="ankschoubey/blog"
        issue-term="title"
        label="blogpost-comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script> -->

  <div id="disqus_thread"></div>
  <script>
    var disqus_config = function () {
      this.page.url = 'https://www.ankushchoubey.com/n-plus-one-hibernate/';
      this.page.identifier = 'https://www.ankushchoubey.com/n-plus-one-hibernate/';
    };
    (function() {
      var d = document, s = d.createElement('script');
      s.src = 'https://ankushchoubey.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a>
</noscript>
<a class="u-url" href="/n-plus-one-hibernate/" hidden></a>
</article>
</head></html>
