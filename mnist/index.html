<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Digit Recognition | Ankush Choubey</title>
<meta name="generator" content="Jekyll v4.1.1">
<meta property="og:title" content="Digit Recognition">
<meta property="og:locale" content="en_US">
<meta name="description" content="MNIST: Kaggle Getting Started">
<meta property="og:description" content="MNIST: Kaggle Getting Started">
<link rel="canonical" href="https://www.ankushchoubey.com/mnist/">
<meta property="og:url" content="https://www.ankushchoubey.com/mnist/">
<meta property="og:site_name" content="Ankush Choubey">
<meta property="og:image" content="https://upload.wikimedia.org/wikipedia/commons/2/27/MnistExamples.png">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2020-03-30T00:00:00-05:00">
<meta name="twitter:card" content="summary_large_image">
<meta property="twitter:image" content="https://upload.wikimedia.org/wikipedia/commons/2/27/MnistExamples.png">
<meta property="twitter:title" content="Digit Recognition">
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2020-03-30T15:42:15-05:00","datePublished":"2020-03-30T00:00:00-05:00","description":"MNIST: Kaggle Getting Started","headline":"Digit Recognition","image":"https://upload.wikimedia.org/wikipedia/commons/2/27/MnistExamples.png","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.ankushchoubey.com/mnist/"},"url":"https://www.ankushchoubey.com/mnist/"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css">
<link type="application/atom+xml" rel="alternate" href="https://www.ankushchoubey.com/feed.xml" title="Ankush Choubey">
<!-- the google_analytics_id gets auto inserted from the config file -->



<script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-35993343-1','auto');ga('require','displayfeatures');ga('send','pageview');</script>



<script id="mcjs">!function(c,h,i,m,p){m=c.createElement(h),p=c.getElementsByTagName(h)[0],m.async=1,m.src=i,p.parentNode.insertBefore(m,p)}(document,"script","https://chimpstatic.com/mcjs-connected/js/users/787ccdfb3a0c625c1830ac78a/859c6d3b694fad02c3eff1603.js");</script><link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico">
<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Digit Recognition | Ankush Choubey</title>
<meta name="generator" content="Jekyll v4.1.1">
<meta property="og:title" content="Digit Recognition">
<meta property="og:locale" content="en_US">
<meta name="description" content="MNIST: Kaggle Getting Started">
<meta property="og:description" content="MNIST: Kaggle Getting Started">
<link rel="canonical" href="https://www.ankushchoubey.com/mnist/">
<meta property="og:url" content="https://www.ankushchoubey.com/mnist/">
<meta property="og:site_name" content="Ankush Choubey">
<meta property="og:image" content="https://upload.wikimedia.org/wikipedia/commons/2/27/MnistExamples.png">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2020-03-30T00:00:00-05:00">
<meta name="twitter:card" content="summary_large_image">
<meta property="twitter:image" content="https://upload.wikimedia.org/wikipedia/commons/2/27/MnistExamples.png">
<meta property="twitter:title" content="Digit Recognition">
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2020-03-30T15:42:15-05:00","datePublished":"2020-03-30T00:00:00-05:00","description":"MNIST: Kaggle Getting Started","headline":"Digit Recognition","image":"https://upload.wikimedia.org/wikipedia/commons/2/27/MnistExamples.png","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.ankushchoubey.com/mnist/"},"url":"https://www.ankushchoubey.com/mnist/"}</script>
<!-- End Jekyll SEO tag -->

<link href="https://unpkg.com/@primer/css/dist/primer.css" rel="stylesheet">
<link rel="stylesheet" href="//use.fontawesome.com/releases/v5.0.7/css/all.css">
<link type="application/atom+xml" rel="alternate" href="https://www.ankushchoubey.com/feed.xml" title="Ankush Choubey">
<!-- the google_analytics_id gets auto inserted from the config file -->



<script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-35993343-1','auto');ga('require','displayfeatures');ga('send','pageview');</script>


    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css" integrity="sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/+DiW/UqRcLbRjq" crossorigin="anonymous">
    <script type="text/javascript" async src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML"> </script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js" integrity="sha384-y23I5Q6l+B6vatafAwxRu/0oK/79VlbSz7Q9aiSZUvyWYIYsd+qj+o24G5ZU2zJz" crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js" integrity="sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI" crossorigin="anonymous"></script>
    <script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement( document.body, {
        delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "[%", right: "%]", display: true},
            {left: "$", right: "$", display: false}
        ]}
        );
    });
    </script>


<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head>
<body>
<header class="site-header">

  <div class="wrapper">
<a class="site-title" rel="author" href="/">Ankush Choubey</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger">
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewbox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"></path>
            </svg>
          </span>
        </label>

        <div class="trigger">
<a class="page-link" href="/core-values-page/">Core Values</a><a class="page-link" href="/philosophy/">Philosophy</a><a class="page-link" href="/resume">Hire me!</a><a class="page-link" href="/search/">Search</a>
</div>
      </nav>
</div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <style>
  .page-content{
    padding-top: 0px;
  }
  .post-header{
    display: flex;
    flex-direction: column;
    justify-content: end;height: 300px;}

  .cover-image{
    position: absolute;
    left:0px;
    height: 300px;
    object-fit: cover;
    width: 100%;
  }

  @media screen and (max-width: 500px) {
    .post-header{height: 550px;}
    .cover-image{
      height: 550px;
    }
  }
  .post-header-content{backdrop-filter: blur(200px); 
    padding: 0px 20px;
    -webkit-backdrop-filter: blur(200px);
        background: #ffffffcf;}
</style>

<header class="post-header"><img src="https://upload.wikimedia.org/wikipedia/commons/2/27/MnistExamples.png" class="cover-image"><div class="post-header-content">
    <h1 class="post-title p-name" itemprop="name headline">Digit Recognition</h1>
<p class="page-description">MNIST: Kaggle Getting Started</p>
<p class="post-meta post-meta-title"><time class="dt-published" datetime="2020-03-30T00:00:00-05:00" itemprop="datePublished">
        Mar 30, 2020
      </time>
      â€¢ <span class="read-time" title="Estimated read time">
    
    
      6 min read
    
</span></p>

    
    <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i>
      
      <a class="category-tags-link" href="/categories/#deep-learning">deep-learning</a>
      
      
    </p>
    

    </div>
</header>
<article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <div class="post-content e-content" itemprop="articleBody">
    <hr>
<h3 id="how-to-read-this">How to read this?</h3>
<ol>
  <li>
    <p>Skim through the <a href="https://medium.com/p/c06251780b">Pre-requisites</a></p>
  </li>
  <li>
    <p>Open each commit notebook then read the explanations.</p>
  </li>
  <li>
    <p>Just run each notebook top to bottom.</p>
  </li>
  <li>
    <p>Try to understand each line.</p>
  </li>
  <li>
    <p>If you find yourself stuck at statements, explore the variable involved.</p>
  </li>
  <li>
    <p>Still, <strong>stuck</strong>?? <strong>highlight the explanation and comment</strong>. I will get back to your query.</p>
  </li>
</ol>

<hr>

<h3 id="commit-version-2-getting-input-and-generating-submission-file">
<a href="https://www.kaggle.com/ankschoubey/20200324-pytorch-mnist?scriptVersionId=30660257">Commit Version 2</a>: Getting Input and Generating Submission File</h3>

<ul>
  <li>
    <p><em>Day 1</em></p>
  </li>
  <li>
    <p>Score â€” 0.43</p>
  </li>
  <li>
    <p>Time invested â€” about an hour</p>
  </li>
</ul>

<p>My goal for any first commit is always to get input, pass it through a NN and generate a submittable output.</p>

<h4 id="read-the-data">Read the data</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">train_df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s">'/kaggle/input/digit-recognizer/train.csv'</span><span class="p">)</span>
</code></pre></div></div>

<h4 id="trainingtesting">Training/testing</h4>

<p>I needed a way to separate features and labels.</p>

<p>So the easiest way was to not select a column named â€˜labelâ€™.</p>

<p><em>test_df</em> does not contain a label column</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">train_df</span><span class="p">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">train_df</span><span class="p">.</span><span class="n">columns</span> <span class="o">!=</span> <span class="s">'label'</span><span class="p">]</span>
<span class="nb">type</span><span class="p">(</span><span class="n">test_df</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'label'</span><span class="p">))</span> <span class="o">==</span> <span class="bp">None</span>
<span class="c1">#false
</span></code></pre></div></div>

<h4 id="dataset">Dataset</h4>

<p>Returns features and labels if â€˜train=Trueâ€™. else it returns just features</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">MnistDataset</span><span class="p">(</span><span class="n">Dataset</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="c1">#convert df to self.X and self.y using above
</span>
    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">X</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">train</span><span class="p">:</span> <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="p">.</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</code></pre></div></div>

<p>Observation: Even if I donâ€™t explicitly mention Tensor, NumPy is converted to tensor.</p>

<h4 id="creating-dataloader">Creating DataLoader</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">bs</span> <span class="o">=</span> <span class="mi">64</span>
<span class="n">ds</span> <span class="o">=</span> <span class="n">MnistDataset</span><span class="p">(</span><span class="n">train_df</span><span class="p">)</span>
<span class="n">dl</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">bs</span><span class="p">)</span>
</code></pre></div></div>

<h4 id="checking-if-dataloader-returns-the-right-output">Checking if DataLoader returns the right output</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">images</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">dl</span><span class="p">))</span>
<span class="n">images</span><span class="p">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">labels</span><span class="p">.</span><span class="n">shape</span>
</code></pre></div></div>

<h4 id="creating-a-vanilla-neural-network">Creating a vanilla Neural Network</h4>

<p>I created a dumb NN just so that I can pass data through it and get output in the desired shape.</p>

<p>The details donâ€™t matter much. This will be replaced by a CNN later.</p>

<h4 id="preparing-the-training-loop">Preparing the training loop</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">epochs</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">loss_fn</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="n">CrossEntropyLoss</span><span class="p">()</span>

<span class="kn">import</span> <span class="nn">torch.optim</span> <span class="k">as</span> <span class="n">optim</span>
<span class="n">o</span> <span class="o">=</span> <span class="n">optim</span><span class="p">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">net</span><span class="p">.</span><span class="n">parameters</span><span class="p">())</span>
</code></pre></div></div>

<h4 id="creating-the-training-loop">Creating the training loop</h4>

<p>Here are the 4 steps to create a basic training loop</p>

<ol>
  <li><strong>Loop epoch number of times</strong></li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">epochs</span><span class="p">):</span>
    <span class="p">...</span>
</code></pre></div></div>

<ol>
  <li>Inside the epoch loop, <strong>loop through data loader</strong> (dl)</li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> <span class="n">images</span><span class="p">,</span> <span class="n">labels</span> <span class="ow">in</span> <span class="n">dl</span><span class="p">:</span>
    <span class="p">...</span>
</code></pre></div></div>

<ol>
  <li>Inside the data loader loop,</li>
</ol>

<ul>
  <li>
    <p><strong>zero</strong> <strong>grad optimizer</strong> <strong>before passing pushing data</strong> into NN.</p>
  </li>
  <li>
    <p>Take an <strong>optimizer step after pushing data</strong> through NN.</p>
  </li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">o</span><span class="p">.</span><span class="n">zero_grad</span><span class="p">()</span>
<span class="p">...</span>
<span class="n">o</span><span class="p">.</span><span class="n">step</span><span class="p">()</span>
</code></pre></div></div>

<ol>
  <li>Between optimizer zero_grad and optimizer step, <strong>pass data through the NN, compute loss and gradients.</strong>
</li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">out</span> <span class="o">=</span> <span class="n">net</span><span class="p">(</span><span class="n">images</span><span class="p">.</span><span class="nb">float</span><span class="p">())</span>
<span class="n">loss</span> <span class="o">=</span> <span class="n">loss_fn</span><span class="p">(</span><span class="n">out</span><span class="p">.</span><span class="nb">float</span><span class="p">(),</span> <span class="n">labels</span><span class="p">.</span><span class="nb">long</span><span class="p">())</span>
<span class="n">loss</span><span class="p">.</span><span class="n">backward</span><span class="p">()</span>
</code></pre></div></div>

<h4 id="generating-output">Generating output</h4>

<p>A similar step as above has been taken to generate test_dl and the testing loop.</p>

<p>The only difference,</p>

<ul>
  <li>
    <p>test_dl has â€˜train=trueâ€™. Dataset will only return features and not labels.</p>
  </li>
  <li>
    <p>code to not calculate gradients since we are not training.</p>
  </li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">with</span> <span class="n">torch</span><span class="p">.</span><span class="n">no_grad</span><span class="p">():</span>
    <span class="p">...</span>
</code></pre></div></div>

<ul>
  <li>
    <p>The output is in the form of numbers from 0â€¦9.</p>
  </li>
  <li>
    <p>Our output is a column <strong><em>(dim=1)</em></strong> array of length 10 with probability.</p>
  </li>
  <li>
    <p>The maximum of this array is our output.</p>
  </li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">out</span><span class="p">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div></div>

<p>We store these outputs in an <strong>outputs</strong> python list.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">test_df</span><span class="p">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">sample_df</span><span class="p">.</span><span class="n">shape</span>
<span class="c1"># Out[17]: ((28000, 784), (28000, 2))
</span></code></pre></div></div>

<ul>
  <li>
    <p>I realized that sample submission and output df have the same length.</p>
  </li>
  <li>
    <p>I just need to add â€˜Labelâ€™ column to the submission data frame and save it in CSV form.</p>
  </li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">sample_df</span><span class="p">[</span><span class="s">'Label'</span><span class="p">]</span> <span class="o">=</span> <span class="n">outputs</span>
<span class="n">sample_df</span><span class="p">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s">'submission.csv'</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</code></pre></div></div>

<p><strong>index=False</strong> removed the default pandas index when saving</p>

<h3 id="commit-version-3-improvements">
<a href="https://www.kaggle.com/ankschoubey/20200324-pytorch-mnist?scriptVersionId=30753580">Commit Version 3</a>: Improvements</h3>

<p><em>Changes</em>: Proper Accuracy, Graph, and Data Normalization</p>

<ul>
  <li>
    <p><em>Day 4</em></p>
  </li>
  <li>
    <p>Score â€” 0.96</p>
  </li>
  <li>
    <p>Time invested â€” about an hour</p>
  </li>
</ul>

<h4 id="proper-accuracy">Proper Accuracy</h4>

<p>Accuracy should always be calculated on the validation set.</p>

<p><strong><em>Creating a separate validation set</em></strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">val_len</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span><span class="o">*</span><span class="mf">0.01</span><span class="p">)</span> <span class="c1"># 0.01 percent of data
</span><span class="n">train_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span> <span class="err">â€”</span> <span class="n">val_len</span> <span class="c1"># all other are in training
</span>
<span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="kn">import</span> <span class="n">random_split</span>

<span class="n">train_ds</span><span class="p">,</span> <span class="n">val_ds</span> <span class="o">=</span> <span class="n">random_split</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="p">[</span><span class="n">train_len</span><span class="p">,</span> <span class="n">val_len</span><span class="p">])</span>
</code></pre></div></div>

<p>Likewise, 2 data loaders are created.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">bs</span> <span class="o">=</span> <span class="mi">64</span>
<span class="n">train_dl</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">train_ds</span><span class="p">,</span> <span class="n">bs</span><span class="p">)</span>
<span class="n">val_dl</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">val_ds</span><span class="p">,</span> <span class="n">bs</span><span class="p">)</span>
</code></pre></div></div>

<p><strong><em>Changes in the training loop</em></strong></p>

<p>A separate list called accuracies in created to store the accuracy of an epoch.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">...</span>
<span class="k">with</span> <span class="n">torch</span><span class="p">.</span><span class="n">no_grad</span><span class="p">():</span>
        <span class="n">accuracy</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">images</span><span class="p">,</span> <span class="n">labels</span> <span class="ow">in</span> <span class="n">val_dl</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">net</span><span class="p">(</span><span class="n">images</span><span class="p">.</span><span class="nb">float</span><span class="p">())</span>
            <span class="n">accuracy</span><span class="o">+=</span><span class="p">(</span><span class="n">out</span><span class="p">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">labels</span><span class="p">).</span><span class="nb">sum</span><span class="p">().</span><span class="n">item</span><span class="p">()</span>
        <span class="n">accuracies</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">accuracy</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">val_ds</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
</code></pre></div></div>

<h4 id="graph">Graph</h4>

<p>Since the accuracy of each epoch was stored in a separate accuracies list, creating a graph was easy.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>

<span class="n">plt</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">epochs</span><span class="p">),</span> <span class="n">accuracies</span><span class="p">)</span>
</code></pre></div></div>

<h4 id="data-normalization">Data Normalization</h4>

<p>After plotting the graph, I realized accuracy was 43% which is the same as the score of commit 2.</p>

<p>The easiest thing to do was to normalize the data.</p>

<p>Since MNIST images are in the range of 1â€¦250 the easiest thing to do was to divide by 250 which would result in a range of 0â€¦1.</p>

<p>Ideally, the range should be around 0 so an even better approach would be</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="o">/</span><span class="mi">250</span><span class="err">â€“</span><span class="mf">0.5</span>
</code></pre></div></div>

<p>this would result in a range between -0.5â€¦+0.5.</p>

<p>Later we would use <code class="language-plaintext highlighter-rouge">torchvision.transforms.Normalize</code>(<em>mean</em>, <em>std</em>, <em>inplace=False</em>) which generates unique normalization value for each dataset</p>

<h3 id="commit-6-convnet-and-gpu">
<a href="https://www.kaggle.com/ankschoubey/20200326-pytorch-mnist?scriptVersionId=30896320">Commit 6</a>: ConvNet, and GPU</h3>

<ul>
  <li>
    <p>Day 6</p>
  </li>
  <li>
    <p>Score â€” 0.97</p>
  </li>
  <li>
    <p>Time invested â€” about 2 hours (lots of googling and reading docs) + 1 hours fixes bugs</p>
  </li>
</ul>

<h4 id="convnet">ConvNet</h4>

<p>Convolutional Neural Networks are ideal images.</p>

<p><strong><em>ResNet</em></strong></p>

<p>ResNet 34 is my goto ConvNet but since MNIST is so easy, I went with ResNet 18.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">torchvision.models</span> <span class="k">as</span> <span class="n">models</span>
<span class="n">resnet18</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">resnet18</span><span class="p">(</span><span class="n">pretrained</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">resnet18</span><span class="p">.</span><span class="n">fc</span> <span class="c1">#print fully connected network
</span></code></pre></div></div>

<p>ResNet is designed to output 1000 classes. But our output is from 0â€¦9 aka 10 classes.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">lin_in</span> <span class="o">=</span> <span class="n">resnet18</span><span class="p">.</span><span class="n">fc</span><span class="p">.</span><span class="n">in_features</span>

<span class="kn">import</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="n">nn</span>

<span class="n">resnet18</span><span class="p">.</span><span class="n">fc</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="n">Sequential</span><span class="p">(</span>
    <span class="n">nn</span><span class="p">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">lin_in</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
    <span class="n">nn</span><span class="p">.</span><span class="n">Softmax</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="p">)</span>
</code></pre></div></div>

<p><strong><em>Convert Grayscale to RGB image</em></strong></p>

<p>ResNet expects RGB images. MNIST is grayscale.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="p">.</span><span class="n">view</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">).</span><span class="n">expand</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">)</span><span class="err">`</span>
</code></pre></div></div>

<p>This <a href="https://discuss.pytorch.org/t/grayscale-to-rgb-transform/18315/7">grayscale to the RGB</a> line is added to our Dataset class.</p>

<p><strong><em>Normalization</em></strong></p>

<p>When using an existing model, we need to use the same normalization values as that model. The <a href="#https://pytorch.org/docs/stable/torchvision/models.html">docs mention the normalization value</a>.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span>  <span class="nn">torchvision.transforms</span> <span class="k">as</span> <span class="n">transforms</span>
<span class="n">normalize</span> <span class="o">=</span> <span class="n">transforms</span><span class="p">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">mean</span><span class="o">=</span><span class="p">[</span><span class="mf">0.485</span><span class="p">,</span> <span class="mf">0.456</span><span class="p">,</span> <span class="mf">0.406</span><span class="p">],</span>
                                 <span class="n">std</span><span class="o">=</span><span class="p">[</span><span class="mf">0.229</span><span class="p">,</span> <span class="mf">0.224</span><span class="p">,</span> <span class="mf">0.225</span><span class="p">])</span>
</code></pre></div></div>

<p>The <strong>init</strong> and <strong>getitem</strong> dataset class have been modified to use this transformation.</p>

<p>Modifications have also been made to test_ds.</p>

<h4 id="gpu">GPU</h4>

<p>One I started the training loop, I realized it suddenly became too slow.</p>

<p>GPU is needed!</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">device</span><span class="p">(</span><span class="s">'cuda:0'</span><span class="p">)</span> <span class="k">if</span> <span class="n">torch</span><span class="p">.</span><span class="n">cuda</span><span class="p">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s">'cpu'</span>
</code></pre></div></div>

<p>If the GPU is on, the device will be <em>cuda</em>.</p>

<p>The neural network and the data in training, validation and texting loop have been changed to run on GPU.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">net</span> <span class="o">=</span> <span class="n">net</span><span class="p">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<span class="p">...</span>

<span class="n">images</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">images</span><span class="p">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="p">.</span><span class="nb">float</span><span class="p">),</span> <span class="n">labels</span><span class="p">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</code></pre></div></div>

<p>And since we are on GPU we can increase our batch size from 64 to much higher.</p>

<p>I experimented with a few sizes from 320â€¦640 and kept an eye on GPU utilization and settled for 512.</p>

<p><img src="/images/2020-03-30-digit-recognition/1.png" alt="CPU and GPU Utilization. Also, see the number of tabs open."></p>

<p>I did the same for <a href="https://discuss.pytorch.org/t/guidelines-for-assigning-num-workers-to-dataloader/813/2">num_worker</a> which specifies the number of threads to load a batch. This is CPU stuff.</p>

<p>Along with monitoring GPU and CPU usage, I modified training_loop to show the <a href="https://stackoverflow.com/a/36423341">amount of time taken to complete each epoch</a>.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">bs</span> <span class="o">=</span> <span class="mi">512</span>
<span class="n">num_workers</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">train_dl</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">train_ds</span><span class="p">,</span> <span class="n">bs</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="n">num_workers</span><span class="p">)</span>
<span class="n">val_dl</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">val_ds</span><span class="p">,</span> <span class="n">bs</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="n">num_workers</span><span class="p">)</span>
</code></pre></div></div>

<p>This resulted in 7 seconds per epoch.</p>

<p>For testing, the batch_size can be much higher since we donâ€™t have to back prop.</p>

<h3 id="commit-7-improvement">
<a href="https://www.kaggle.com/ankschoubey/20200326-pytorch-mnist/output?scriptVersionId=31120757">Commit 7</a>: Improvement</h3>

<ul>
  <li>
    <p>Day 8</p>
  </li>
  <li>
    <p>Score â€” 0.97</p>
  </li>
  <li>
    <p>Time invested â€” about 30 minutes</p>
  </li>
</ul>

<p>I learned that you donâ€™t need <a href="https://discuss.pytorch.org/t/vgg-output-layer-no-softmax/9273">nn.Softmax if you are using nn.CrossEntropyLoss</a>.</p>

<p>nn.CrossEntropyLoss has nn.Softmax built-in and the results of softmax are not used during back-prop. So it can be safely removed.</p>

<p>Now FC is this:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">lin_in</span> <span class="o">=</span> <span class="n">resnet18</span><span class="p">.</span><span class="n">fc</span><span class="p">.</span><span class="n">in_features</span>

<span class="kn">import</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="n">nn</span>

<span class="n">resnet18</span><span class="p">.</span><span class="n">fc</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="n">Sequential</span><span class="p">(</span>
    <span class="n">nn</span><span class="p">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">lin_in</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="p">)</span>
</code></pre></div></div>
<hr>

<p>Index: <a href="/deep%20learning/kaggle/2020/03/30/series-kaggle-getting-started.html">Series - Kaggle Getting Started</a></p>

<p>Next Post: []</p>

  </div>
<div id="mc_embed_shell">
        <link href="//cdn-images.mailchimp.com/embedcode/classic-061523.css" rel="stylesheet" type="text/css">
    <style type="text/css">
          #mc_embed_signup{background:#fff; false;clear:left; font:14px Helvetica,Arial,sans-serif; width: 600px;}
          /* Add your own Mailchimp form style overrides in your site stylesheet or in this style block.
             We recommend moving this block and the preceding CSS link to the HEAD of your HTML file. */
  </style>
  <div id="mc_embed_signup">
      <form action="https://ankushchoubey.us21.list-manage.com/subscribe/post?u=787ccdfb3a0c625c1830ac78a&id=51f57ce68a&f_id=002959e1f0" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank">
          <div id="mc_embed_signup_scroll">
<h2>Join me for captivating articles at the crossroads of Software Engineering and Philosophy.</h2>
              <div class="indicates-required">
<span class="asterisk">*</span> indicates required</div>
              <div class="mc-field-group">
<label for="mce-EMAIL">Email Address <span class="asterisk">*</span></label><input type="email" name="EMAIL" class="required email" id="mce-EMAIL" required="" value=""><span id="mce-EMAIL-HELPERTEXT" class="helper_text"></span>
</div>
          <div id="mce-responses" class="clear foot">
              <div class="response" id="mce-error-response" style="display: none;"></div>
              <div class="response" id="mce-success-response" style="display: none;"></div>
          </div>
      <div aria-hidden="true" style="position: absolute; left: -5000px;">
          /* real people should not fill this in and expect good things - do not remove this or risk form bot signups */
          <input type="text" name="b_787ccdfb3a0c625c1830ac78a_51f57ce68a" tabindex="-1" value="">
      </div>
          <div class="optionalParent">
              <div class="clear foot">
                  <input type="submit" name="subscribe" id="mc-embedded-subscribe" class="button" value="Subscribe">
                  <p class="brandingLogo" style="margin: 0px auto;"><a href="http://eepurl.com/iwHRjY" title="Mailchimp - email marketing made easy and fun"><img src="https://eep.io/mc-cdn-images/template_images/branding_logo_text_dark_dtp.svg" alt="referral badge"></a></p>
              </div>
          </div>
      </div>
  </form>
  </div>
  <script type="text/javascript" src="//s3.amazonaws.com/downloads.mailchimp.com/js/mc-validate.js"></script><script type="text/javascript">(function($) {window.fnames = new Array(); window.ftypes = new Array();fnames[0]='EMAIL';ftypes[0]='email';fnames[1]='FNAME';ftypes[1]='text';fnames[2]='LNAME';ftypes[2]='text';fnames[3]='ADDRESS';ftypes[3]='address';fnames[4]='PHONE';ftypes[4]='phone';fnames[5]='BIRTHDAY';ftypes[5]='birthday';}(jQuery));var $mcj = jQuery.noConflict(true);</script>
</div>

<style>
    div#mc_embed_signup{
        width: auto !important;
        display: flex;
        justify-content: center;
        align-content: center;
    }
    form#mc_embed_signup{
        max-width: 800px !important;
    }
    #mc_embed_signup .mc-field-group{
        padding-bottom: 0% !important;
    }

    #mc_embed_signup h2{
        margin: 0px !important;
    }
    #mc_embed_signup .brandingLogo{
        display: none !important;
    }
</style>
<div id="disqus_thread"></div>
  <script>
    var disqus_config = function () {
      this.page.url = 'https://www.ankushchoubey.com/mnist/';
      this.page.identifier = 'https://www.ankushchoubey.com/mnist/';
    };

    (function() {
      var d = document, s = d.createElement('script');

      s.src = 'https://ankushchoubey.disqus.com/embed.js';

      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a>
</noscript>
<a class="u-url" href="/mnist/" hidden></a>
</article>
      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="https://www.ankushchoubey.com/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>Full Stack Developer - Cloud/Microservices</p>
      </div>
    </div>

    <div class="social-links">
<ul class="social-media-list">
<li>
  <a rel="me" href="https://github.com/ankschoubey" target="_blank" title="github">
    <svg class="svg-icon grey">
      <use xlink:href="/assets/minima-social-icons.svg#github"></use>
    </svg>
  </a>
</li>
<li>
  <a rel="me" href="https://twitter.com/ankschoubey" target="_blank" title="twitter">
    <svg class="svg-icon grey">
      <use xlink:href="/assets/minima-social-icons.svg#twitter"></use>
    </svg>
  </a>
</li>
</ul>
</div>

  </div>

</footer>
</body>

</html>
