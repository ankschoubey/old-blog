<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="twitter:card" content="summary_large_image">
<!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Solving a OptimisticLockingException During Upsert in MongoDB-Spring Webflux | Ankush Choubey</title>
<meta name="generator" content="Jekyll v4.1.1">
<meta property="og:title" content="Solving a OptimisticLockingException During Upsert in MongoDB-Spring Webflux">
<meta property="og:locale" content="en_US">
<meta name="description" content="I faced a unique problem and it is worth writing about. The cause was parallel access and saving of a single document that caused OptimisticLockingException.">
<meta property="og:description" content="I faced a unique problem and it is worth writing about. The cause was parallel access and saving of a single document that caused OptimisticLockingException.">
<link rel="canonical" href="www.ankushchoubey.com/optimistic-locking-exception-mongodb/">
<meta property="og:url" content="www.ankushchoubey.com/optimistic-locking-exception-mongodb/">
<meta property="og:site_name" content="Ankush Choubey">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2022-04-16T00:00:00-05:00">
<script type="application/ld+json">
{"url":"www.ankushchoubey.com/optimistic-locking-exception-mongodb/","@type":"BlogPosting","headline":"Solving a OptimisticLockingException During Upsert in MongoDB-Spring Webflux","dateModified":"2022-04-16T15:52:08-05:00","datePublished":"2022-04-16T00:00:00-05:00","mainEntityOfPage":{"@type":"WebPage","@id":"www.ankushchoubey.com/optimistic-locking-exception-mongodb/"},"description":"I faced a unique problem and it is worth writing about. The cause was parallel access and saving of a single document that caused OptimisticLockingException.","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css">
<link type="application/atom+xml" rel="alternate" href="www.ankushchoubey.com/feed.xml" title="Ankush Choubey">
<!-- the google_analytics_id gets auto inserted from the config file -->



<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-35993343-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-35993343-1');
</script>


<link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Primer/15.2.0/primer.css" integrity="sha512-xTz2ys4coGAOz8vuV1NcQBkgVmKhsSEtjbqyMJbBHRplFuvKIUo6xhLHpAyPt9mfR6twHJgn9OgVLuqOvjeBhg==" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.css" integrity="sha512-h7nl+xz8wgDlNM4NqKEM4F1NkIRS17M9+uJwIGwuo8vGqIl4BhuCKdxjWEINm+xyrUjNCnK5dCrhM0sj+wTIXw==" crossorigin="anonymous">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.js" integrity="sha512-/CMIhXiDA3m2c9kzRyd97MTb3MC6OVnx4TElQ7fkkoRghwDf6gi41gaT1PwF270W6+J60uTmwgeRpNpJdRV6sg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/contrib/auto-render.min.js" integrity="sha512-Do7uJAaHZm5OLrIv/yN4w0iG1dbu01kzdMNnFfu/mAqgUk6Nniv2JYHcwH+cNwjqgLcqcuBBk+JRvprLVI8azg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha512-0doc9hKxR3PYwso42RD1p5ySZpzzuDiOwMrdCEh2WdJZCjcmFKc/wEnL+z8fBQrnHoiNWbo+3fiGkOYXBdQp4A==" crossorigin="anonymous"></script>
    <script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement( document.body, {
        delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "[%", right: "%]", display: true},
            {left: "$", right: "$", display: false}
        ]}
        );
    });
    </script>


<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head>
<body>
<header class="site-header">

  <div class="wrapper">
<a class="site-title" rel="author" href="/">Ankush Choubey</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger">
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewbox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"></path>
            </svg>
          </span>
        </label>

        <div class="trigger">
<a class="page-link" href="/philosophy/">Philosophy</a><a class="page-link" href="/resume/">Hire me!</a><a class="page-link" href="/search/">Search</a>
</div>
      </nav>
</div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <!-- <script>
  for (const iterator of document.getElementsByClassName('page-link')) {
      if (iterator.innerHTML === 'Search'){ iterator.classList.add('search-button'); iterator.title = 'Search';}
      if (iterator.innerHTML === 'Tags'){ iterator.classList.add('tags-button'); iterator.title = 'Tags';}
      if (iterator.innerHTML === 'Side Projects'){ iterator.classList.add('side-project-button'); iterator.title = 'Side Projects';}
  }
</script> -->


<script type="text/javascript" src="/assets/accordian.js"></script>

<article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Solving a OptimisticLockingException During Upsert in MongoDB-Spring Webflux</h1>

    <p class="post-meta post-meta-title"><time class="dt-published post-meta-created-date" datetime="2022-04-16T00:00:00-05:00" itemprop="datePublished">
        Written: Apr 16, 2022
      </time>~<time class="dt-modified post-meta-last-modified-date" datetime="2022-04-16T15:52:08-05:00" itemprop="dateModified">
          Updated: Apr 16, 2022
        </time>
       • <span class="read-time" title="Estimated read time">
    
    
      2 min read
    
</span></p>    <style>
        .post-tool-bar{
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0px 10px 0px;
            /* border: 1px solid #e8e8e8; */
            border-width: 0px 0px 1px 0px;
        }
        .left-section , .right-section{
            display: flex;
            gap: 8px;
        }

    </style>
    
    <div class="post-tool-bar">
<!-- <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
<script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
<script>
        AOS.init();
</script> -->

<div class="tag-list">
    
    <a class="tag fa fa-hashtag database" href="/categories/#database">database</a>
    
    <a class="tag fa fa-hashtag mongodb" href="/categories/#mongodb">mongodb</a>
    
    <a class="tag fa fa-hashtag spring-boot" href="/categories/#spring-boot">spring-boot</a>
    
    <a class="tag fa fa-hashtag tdd-example" href="/categories/#tdd-example">tdd-example</a>
    
</div>
<div class="right-section">
<a id="translate-btn" href="https://www.translatetheweb.com/?ref=TAns&from=&to=hi&a=https%3A%2F%2Fwww.ankushchoubey.com%2F">
    <img src="/images/icons/translate.svg" alt="Translate" style="width:35px">
</a>


<script>
    a = document.getElementById('translate-btn');
    a.setAttribute("href", "https://www.translatetheweb.com/?ref=TAns&from=&to=hi&a=" + window.location.href);
</script><a id="speech-btn">
    <img src="/images/icons/ear.svg" alt="listen" style="width:35px; cursor: pointer;">
</a>

<script>
    speakPost = () => {
        var msg = new SpeechSynthesisUtterance();
        const title = document.querySelector("h1.post-title.p-name").innerText;
        const post = document.querySelector("div.post-content.e-content").innerText
        msg.text = title + '.' + post;
        window.speechSynthesis.speak(msg);
    }
    if ('speechSynthesis' in window) {
        document.getElementById("speech-btn").addEventListener("click", speakPost);
    } else {
        document.getElementById('speech-btn').style.display = 'none';
    }
</script>

<!-- https://www.alebalweb-blog.com/85-text-to-speech-player-with-buttons-play-pause-stop-and-voice-choice.html -->
</div>
      
          
    </div>
    
</header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>I faced a unique problem and it is worth writing about. The cause was parallel access and saving of a single document that caused <code class="language-plaintext highlighter-rouge">OptimisticLockingException</code>.</p>

<h1 id="problem"><strong>Problem</strong></h1>

<p>I had a <code class="language-plaintext highlighter-rouge">@Document</code> which had to be manupilated.</p>

<p>The <code class="language-plaintext highlighter-rouge">@Document</code> had a repository which extended <code class="language-plaintext highlighter-rouge">ReactiveMongoRepository</code>.</p>

<p>So it was something like this</p>

<p><strong>SampleDocument.java</strong></p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Document</span><span class="o">(</span><span class="s">"sample_document"</span><span class="o">)</span>
<span class="kd">class</span> <span class="nc">SampleDocument</span><span class="o">{</span>
    <span class="nd">@Version</span>
    <span class="nc">Long</span> <span class="n">version</span><span class="o">;</span>

    <span class="nd">@Indexed</span><span class="o">(</span><span class="n">backgroud</span><span class="o">=</span><span class="kc">true</span><span class="o">)</span>
    <span class="nc">String</span> <span class="n">customId</span><span class="o">;</span>

    <span class="nc">String</span> <span class="n">fieldToBeModified</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Notice <code class="language-plaintext highlighter-rouge">@Version</code> annotation</p>

<p><strong>SampleRepository.java</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">interface</span> <span class="nc">SampleRepository</span> <span class="kd">extends</span> <span class="nc">ReactiveMongoRepository</span> <span class="o">&lt;</span><span class="nc">SampleDocument</span><span class="o">&gt;{</span>
    <span class="nc">Mono</span><span class="o">&lt;</span><span class="nc">SampleDocument</span><span class="o">&gt;</span> <span class="nf">findByCustomId</span><span class="o">(</span><span class="nc">String</span> <span class="n">customId</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>To update the document I had webflux code written like this:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">repository</span><span class="o">.</span><span class="na">findByCustomId</span><span class="o">(</span><span class="n">someString</span><span class="o">)</span>   <span class="c1">// Step 1</span>
<span class="o">.</span><span class="na">flatmap</span><span class="o">(</span><span class="n">sampleDocument</span><span class="o">-&gt;{</span>
    <span class="c1">// manipulation of document         // Step 2</span>
    <span class="k">return</span> <span class="nc">Mono</span><span class="o">.</span><span class="na">just</span><span class="o">(</span><span class="n">sampleDocument</span><span class="o">)</span>
<span class="o">})</span>
<span class="o">.</span><span class="na">flatmap</span><span class="o">(</span><span class="n">sampleDocument</span> <span class="o">-&gt;</span> 
    <span class="n">repository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">sampleDocument</span><span class="o">)</span>     <span class="c1">// Step 3</span>
<span class="o">);</span> 
</code></pre></div></div>

<p>As you can see, the code to fetch the document (Step 1) and to save (Step 3) back are two separate lines. Between the lines are steps to manipulate the document (Step 2).</p>

<p>This was what caused the problem.</p>

<p>MongoDB uses version field in a document to maintain Locking. If the current <code class="language-plaintext highlighter-rouge">version</code> is <code class="language-plaintext highlighter-rouge">10</code> and you try to save <code class="language-plaintext highlighter-rouge">8</code> then this would lead to <code class="language-plaintext highlighter-rouge">OptimisticLockingException</code>.</p>

<p>In a concurrent environment like webflux when multiple thread are reading from the same data, it’s highly likely that the order the record is updated by some other thread before the current thread saves the data again.</p>

<p>This would specially be true where there are lots of upsert/update queries.</p>

<h1 id="solution"><strong>Solution</strong></h1>

<p>To fix this I switched to manually writing an update query and executing with <code class="language-plaintext highlighter-rouge">MongoOperation</code>.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Update</span> <span class="n">updateQuery</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Update</span><span class="o">().</span> <span class="c1">// code to update document</span>

<span class="k">return</span> <span class="n">mongoOperation</span><span class="o">.</span><span class="na">findAndModify</span><span class="o">(</span><span class="n">query</span><span class="o">(</span><span class="n">where</span><span class="o">(</span><span class="s">"custom_id"</span><span class="o">).</span><span class="na">is</span><span class="o">(</span><span class="n">someString</span><span class="o">)),</span> <span class="n">updateQuery</span><span class="o">,</span> <span class="n">options</span><span class="o">().</span><span class="na">returnNew</span><span class="o">(</span><span class="kc">true</span><span class="o">).</span><span class="na">upsert</span><span class="o">(</span><span class="kc">true</span><span class="o">),</span> <span class="nc">SampleDocument</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</code></pre></div></div>

<p>Instead of 2 different DB actions. It became one DB Action.</p>

<p>The update query does not need to bring data back to Webflux server to manipulate the document. The document is manipulated at Database only. The database is therefore responsible for ordering the updates which was fine in my case.</p>

<h1 id="extra-finding-root-cause-and-fixing-with-tdd">
<strong>Extra</strong>: Finding root cause and fixing with TDD</h1>

<p>I’m gonna try to provide examples of TDD wherever possible.</p>

<p>To find the cause, I suspected the data was being saved parallelly.</p>

<p>So I created a unit test as follows.</p>

<ol>
  <li>Manipulate documents parallel. This was done with <code class="language-plaintext highlighter-rouge">@RepeatableTest</code> and <code class="language-plaintext highlighter-rouge">@Execution(CONCURENT)</code>
</li>
  <li>Assertion wasn’t straight forward with <code class="language-plaintext highlighter-rouge">@RepeatableTest</code> so I instead collected all version in a static list.</li>
  <li>After all <code class="language-plaintext highlighter-rouge">@RepeatableTests</code> were over I asserted if version was as expected.</li>
  <li>I ran the code and saw <code class="language-plaintext highlighter-rouge">OptimisticLockingException</code> occuring and assertion failing.</li>
  <li>I replaced <code class="language-plaintext highlighter-rouge">repository</code> <code class="language-plaintext highlighter-rouge">find</code> and <code class="language-plaintext highlighter-rouge">save</code> with <code class="language-plaintext highlighter-rouge">MongoOperation</code> <code class="language-plaintext highlighter-rouge">update</code> as described above.</li>
  <li>The test passed.</li>
</ol>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Nested</span>
<span class="nd">@DisplayName</span><span class="o">(</span><span class="s">"WHEN upsert is called parallely"</span><span class="o">)</span>
<span class="kd">class</span> <span class="nc">WhenUpsertIsCalledParallelyTest</span><span class="o">{</span>
    
    <span class="kd">static</span> <span class="kd">final</span> <span class="nc">Long</span> <span class="n">repeatTimes</span> <span class="o">=</span> <span class="mi">100</span><span class="o">;</span>

    <span class="kd">static</span> <span class="kd">final</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Long</span><span class="o">&gt;</span> <span class="n">allVersions</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>

    <span class="nd">@RepeatableTest</span><span class="o">(</span><span class="n">repeatTimes</span><span class="o">)</span>                           <span class="c1">// Part of Step 1</span>
    <span class="nd">@Execution</span><span class="o">(</span><span class="no">CONCURRENT</span><span class="o">)</span>                                 <span class="c1">// Part of Step 1</span>
    <span class="nd">@DisplayName</span><span class="o">(</span><span class="s">"SHOULD manipulate a single record"</span><span class="o">)</span>
    <span class="kt">void</span> <span class="nf">shouldManipulateASingleRecord</span><span class="o">(){</span>
        <span class="c1">// when:</span>
            <span class="nc">SampleDocument</span> <span class="n">document</span> <span class="o">=</span> <span class="n">myService</span><span class="o">.</span><span class="na">upsert</span><span class="o">(</span><span class="n">someString</span><span class="o">).</span><span class="na">block</span><span class="o">();</span> <span class="c1">// Part of Step 1</span>
        <span class="c1">// data collection:</span>
            <span class="n">allVersions</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">document</span><span class="o">.</span><span class="na">getVersion</span><span class="o">());</span>         <span class="c1">// Part of Step 2</span>
    <span class="o">}</span>

    <span class="nd">@AfterAll</span>
    <span class="kd">static</span> <span class="kt">void</span> <span class="nf">assertVersionIsRepeatTimes</span><span class="o">(){</span>
        <span class="n">assertThat</span><span class="o">(</span><span class="nc">Collections</span><span class="o">.</span><span class="na">max</span><span class="o">(</span><span class="n">version</span><span class="o">))</span>                <span class="c1">// Part of Step 3</span>
            <span class="o">.</span><span class="na">isEqualTo</span><span class="o">(</span><span class="n">repeatTimes</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

  </div>
  <!-- https://david.elbe.me/jekyll/2015/06/20/how-to-link-to-next-and-previous-post-with-jekyll.html -->

<div class="PageNavigation">
    
      <a class="prev" href="/fixing-tools/">« Fixing Tools - IDE, Code Editors, Etc.</a>
    
    
      <a class="next" href="/debugging-effectively/">Debugging Effectively »</a>
    
  </div>

<style>
    .PageNavigation {
  font-size: 14px;
  display: block;
  width: auto;
  overflow: hidden;
}

.PageNavigation a {
  display: block;
  width: 50%;
  float: left;
  margin: 1em 0;
}

.PageNavigation .next {
  text-align: right;
}
</style>
<!-- from https://github.com/utterance/utterances -->
<script src="https://utteranc.es/client.js" repo="ankschoubey/blog" issue-term="title" label="blogpost-comment" theme="github-light" crossorigin="anonymous" async>
</script>

  <div id="disqus_thread"></div>
  <script>
    var disqus_config = function () {
      this.page.url = 'www.ankushchoubey.com/optimistic-locking-exception-mongodb/';
      this.page.identifier = 'www.ankushchoubey.com/optimistic-locking-exception-mongodb/';
    };
    (function() {
      var d = document, s = d.createElement('script');
      s.src = 'https://ankushchoubey.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a>
</noscript>
<a class="u-url" href="/optimistic-locking-exception-mongodb/" hidden></a>
</article>
      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>Full Stack Developer - Cloud/Microservices</p>
      </div>
    </div>

    <div class="social-links">
<ul class="social-media-list">
<li>
  <a rel="me" href="https://github.com/ankschoubey" target="_blank" title="github">
    <svg class="svg-icon grey">
      <use xlink:href="/assets/minima-social-icons.svg#github"></use>
    </svg>
  </a>
</li>
<li>
  <a rel="me" href="https://twitter.com/ankschoubey" target="_blank" title="twitter">
    <svg class="svg-icon grey">
      <use xlink:href="/assets/minima-social-icons.svg#twitter"></use>
    </svg>
  </a>
</li>
</ul>
</div>

  </div>

</footer>
</body>

</html>
