<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="twitter:card" content="summary_large_image">
<!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Making Object Immutable for Concurrency | Ankush Choubey</title>
<meta name="generator" content="Jekyll v4.1.1">
<meta property="og:title" content="Making Object Immutable for Concurrency">
<meta property="og:locale" content="en_US">
<meta name="description" content="It’s best to start with immutable objects and then modify them if needed.">
<meta property="og:description" content="It’s best to start with immutable objects and then modify them if needed.">
<link rel="canonical" href="www.ankushchoubey.com/immutable-objects/">
<meta property="og:url" content="www.ankushchoubey.com/immutable-objects/">
<meta property="og:site_name" content="Ankush Choubey">
<meta property="og:image" content="www.ankushchoubey.com/images/immutable-objects.jpg">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2022-09-18T00:00:00-05:00">
<script type="application/ld+json">
{"url":"www.ankushchoubey.com/immutable-objects/","headline":"Making Object Immutable for Concurrency","datePublished":"2022-09-18T00:00:00-05:00","dateModified":"2022-09-18T15:52:08-05:00","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"www.ankushchoubey.com/immutable-objects/"},"image":"www.ankushchoubey.com/images/immutable-objects.jpg","description":"It’s best to start with immutable objects and then modify them if needed.","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css">
<link type="application/atom+xml" rel="alternate" href="www.ankushchoubey.com/feed.xml" title="Ankush Choubey">
<!-- the google_analytics_id gets auto inserted from the config file -->



<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-35993343-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-35993343-1');
</script>


<link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Primer/15.2.0/primer.css" integrity="sha512-xTz2ys4coGAOz8vuV1NcQBkgVmKhsSEtjbqyMJbBHRplFuvKIUo6xhLHpAyPt9mfR6twHJgn9OgVLuqOvjeBhg==" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.css" integrity="sha512-h7nl+xz8wgDlNM4NqKEM4F1NkIRS17M9+uJwIGwuo8vGqIl4BhuCKdxjWEINm+xyrUjNCnK5dCrhM0sj+wTIXw==" crossorigin="anonymous">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.js" integrity="sha512-/CMIhXiDA3m2c9kzRyd97MTb3MC6OVnx4TElQ7fkkoRghwDf6gi41gaT1PwF270W6+J60uTmwgeRpNpJdRV6sg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/contrib/auto-render.min.js" integrity="sha512-Do7uJAaHZm5OLrIv/yN4w0iG1dbu01kzdMNnFfu/mAqgUk6Nniv2JYHcwH+cNwjqgLcqcuBBk+JRvprLVI8azg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha512-0doc9hKxR3PYwso42RD1p5ySZpzzuDiOwMrdCEh2WdJZCjcmFKc/wEnL+z8fBQrnHoiNWbo+3fiGkOYXBdQp4A==" crossorigin="anonymous"></script>
    <script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement( document.body, {
        delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "[%", right: "%]", display: true},
            {left: "$", right: "$", display: false}
        ]}
        );
    });
    </script>


<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head>
<body>
<header class="site-header">

  <div class="wrapper">
<a class="site-title" rel="author" href="/">Ankush Choubey</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger">
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewbox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"></path>
            </svg>
          </span>
        </label>

        <div class="trigger">
<a class="page-link" href="/philosophy/">Philosophy</a><a class="page-link" href="/resume/">Hire me!</a><a class="page-link" href="/search/">Search</a>
</div>
      </nav>
</div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <!-- <script>
  for (const iterator of document.getElementsByClassName('page-link')) {
      if (iterator.innerHTML === 'Search'){ iterator.classList.add('search-button'); iterator.title = 'Search';}
      if (iterator.innerHTML === 'Tags'){ iterator.classList.add('tags-button'); iterator.title = 'Tags';}
      if (iterator.innerHTML === 'Side Projects'){ iterator.classList.add('side-project-button'); iterator.title = 'Side Projects';}
  }
</script> -->


<script type="text/javascript" src="/assets/accordian.js"></script>

<article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Making Object Immutable for Concurrency</h1>

    <p class="page-description">It's best to start with immutable objects and then modify them if needed.</p>
<p class="post-meta post-meta-title"><time class="dt-published post-meta-created-date" datetime="2022-09-18T00:00:00-05:00" itemprop="datePublished">
        Written: Sep 18, 2022
      </time>~<time class="dt-modified post-meta-last-modified-date" datetime="2022-09-18T15:52:08-05:00" itemprop="dateModified">
          Updated: Sep 18, 2022
        </time>
       • <span class="read-time" title="Estimated read time">
    
    
      2 min read
    
</span></p>    <style>
        .post-tool-bar{
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0px 10px 0px;
            /* border: 1px solid #e8e8e8; */
            border-width: 0px 0px 1px 0px;
        }
        .left-section , .right-section{
            display: flex;
            gap: 8px;
        }

    </style>
    
    <div class="post-tool-bar">
<!-- <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
<script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
<script>
        AOS.init();
</script> -->

<div class="tag-list">
    
    <a class="tag fa fa-hashtag concurrent-programming" href="/categories/#concurrent-programming">concurrent-programming</a>
    
    <a class="tag fa fa-hashtag reactive-programming" href="/categories/#reactive-programming">reactive-programming</a>
    
</div>
<div class="right-section">
<a id="translate-btn" href="https://www.translatetheweb.com/?ref=TAns&from=&to=hi&a=https%3A%2F%2Fwww.ankushchoubey.com%2F">
    <img src="/images/icons/translate.svg" alt="Translate" style="width:35px">
</a>


<script>
    a = document.getElementById('translate-btn');
    a.setAttribute("href", "https://www.translatetheweb.com/?ref=TAns&from=&to=hi&a=" + window.location.href);
</script><a id="speech-btn">
    <img src="/images/icons/ear.svg" alt="listen" style="width:35px; cursor: pointer;">
</a>

<script>
    speakPost = () => {
        var msg = new SpeechSynthesisUtterance();
        const title = document.querySelector("h1.post-title.p-name").innerText;
        const post = document.querySelector("div.post-content.e-content").innerText
        msg.text = title + '.' + post;
        window.speechSynthesis.speak(msg);
    }
    if ('speechSynthesis' in window) {
        document.getElementById("speech-btn").addEventListener("click", speakPost);
    } else {
        document.getElementById('speech-btn').style.display = 'none';
    }
</script>

<!-- https://www.alebalweb-blog.com/85-text-to-speech-player-with-buttons-play-pause-stop-and-voice-choice.html -->
</div>
      
          
    </div>
    
</header>

  <div class="post-content e-content" itemprop="articleBody">
    <ul class="section-nav">
<li class="toc-entry toc-h1"><a href="#where-immutability-is-needed">Where Immutability is needed?</a></li>
<li class="toc-entry toc-h1"><a href="#creating-an-immutable-object">Creating an immutable object</a></li>
<li class="toc-entry toc-h1"><a href="#java-libraries">Java Libraries</a></li>
<li class="toc-entry toc-h1"><a href="#automating-verification-via-unit-tests">Automating Verification via Unit Tests</a></li>
<li class="toc-entry toc-h1"><a href="#resources">Resources</a></li>
</ul>
<p><img src="/images/immutable-objects.jpg" alt=""></p>

<p><sup>Photo by <a href="https://unsplash.com/@davehoefler?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText">Dave Hoefler</a> on <a href="https://unsplash.com/s/photos/stone?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText">Unsplash</a></sup></p>

<div class="flash">
    <svg class="octicon octicon-info octicon octicon-info octicon octicon-info octicon octicon-info" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z"></path></svg>
    <strong>Note: </strong>For beginners: Immutable object means objects whose value can't change. Immutability is the intent of the creator of the object/class, i.e. when coding something up, we need to decide if a particular class should be immutable. Also, immutability is as important in the front end as in the back end. While the below posts explain it in Java, other programming languages have their way of implementing immutability.
</div>

<h1 id="where-immutability-is-needed">
<a class="anchor" href="#where-immutability-is-needed" aria-hidden="true"><span class="octicon octicon-link"></span></a><strong>Where Immutability is needed?</strong>
</h1>

<p>When sharing data between threads, there is a high chance that one memory gets replaced by another. This would lead to inconsistency, and often these bugs aren’t discovered.</p>

<p>There are two ways to avoid this: thread-safe data structures or immutable objects.</p>

<p>This particular post will explain where immutable objects are necessary.</p>

<p>Suppose you have 2 Rest Endpoints. <code class="language-plaintext highlighter-rouge">/someEndpoint</code> and <code class="language-plaintext highlighter-rouge">/anotherEndpoint</code> both set a particular value to the variable <code class="language-plaintext highlighter-rouge">sharedMemory</code>.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="nc">String</span> <span class="n">sharedMemory</span><span class="o">;</span>

<span class="nd">@PostMapping</span><span class="o">(</span><span class="s">"/someEndpoint"</span><span class="o">)</span>
<span class="kt">void</span> <span class="nf">postSomething</span><span class="o">(</span><span class="nd">@RequestBody</span> <span class="nc">String</span> <span class="n">value</span><span class="o">){</span>
    <span class="n">sharedMemory</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>
    <span class="o">....</span>
   <span class="c1">//some code that uses sharedMemory</span>
<span class="o">}</span>

<span class="nd">@PostMapping</span><span class="o">(</span><span class="s">"/anotherEndpoint"</span><span class="o">)</span>
<span class="kt">void</span> <span class="nf">postSomethingElse</span><span class="o">(</span><span class="nd">@RequestBody</span> <span class="nc">String</span> <span class="n">value</span><span class="o">){</span>
    <span class="n">sharedMemory</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>
    <span class="o">....</span>
   <span class="c1">//some code that uses sharedMemory</span>
<span class="o">}</span>
</code></pre></div></div>

<p>It can happen that this shared memory is not inconsistent.</p>

<p>Ideally, the solution would be, in this case, to declare the variable within the method it is used.</p>

<h1 id="creating-an-immutable-object">
<a class="anchor" href="#creating-an-immutable-object" aria-hidden="true"><span class="octicon octicon-link"></span></a><strong>Creating an immutable object</strong>
</h1>

<p>The creation of immutable objects is relatively simple.</p>
<ol>
  <li>Make sure all instance variables are <code class="language-plaintext highlighter-rouge">private final</code>.</li>
  <li>make sure all interactions with the method happens only via the constructor or the public method.
No method should modify the contents of the private final method.</li>
  <li>Make sure all instance variables are immutable.</li>
  <li>Make sure the class is <code class="language-plaintext highlighter-rouge">final</code> so that there is no inheriting and subclasses can’t override something.</li>
</ol>

<p>There are some more rules, but these are the minimum requirements. The following section will explain how you automate the checking of immutable classes would also check for more conditions.</p>

<h1 id="java-libraries">
<a class="anchor" href="#java-libraries" aria-hidden="true"><span class="octicon octicon-link"></span></a><strong>Java Libraries</strong>
</h1>

<p>Some libraries help create immutable objects, such as <a href="https://immutables.github.io/">Immutables for Java</a>.</p>

<p><a href="https://github.com/google/guava/wiki/ImmutableCollectionsExplained">Google Guava Library</a> provides many immutable data structure alternatives. The benefit of using these is that they have the same interface as regular java collections.</p>

<div class="flash">
    <svg class="octicon octicon-info octicon octicon-info octicon octicon-info octicon octicon-info octicon octicon-info" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z"></path></svg>
    <strong>Note: </strong>It's best to start with immutable objects and then modify them if needed.
</div>

<h1 id="automating-verification-via-unit-tests">
<a class="anchor" href="#automating-verification-via-unit-tests" aria-hidden="true"><span class="octicon octicon-link"></span></a><strong>Automating Verification</strong> via Unit Tests</h1>

<p>But when developing within a team and given the cognitive overload we developers face, we need some way to automate the creation of immutable objects. This can be done as a combo of 2 methods:</p>

<p><strong>#1 Mutability Detector</strong></p>

<p>Mutability Detector is a package that provides the following assertion that can be used within unit tests.</p>

<p>Mutability Detector has many more conditions to detect mutability.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    assertImmutable(MyClass.class); 
</code></pre></div></div>

<p><a href="https://github.com/MutabilityDetector/MutabilityDetector">Github Source</a></p>

<p><strong>#2 Automate further with ArchUnit tests</strong></p>

<p>ArchUnit tests allow for writing architecture-level tests. We can write a test such as asserting that a class is immutable if a class is annotated with @component.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
</code></pre></div></div>

<p>In practice, I couldn’t fully make <code class="language-plaintext highlighter-rouge">assertImmutable</code> work with abstract classes.</p>

<h1 id="resources">
<a class="anchor" href="#resources" aria-hidden="true"><span class="octicon octicon-link"></span></a><strong>Resources</strong>
</h1>

<ul>
  <li><a href="https://www.youtube.com/watch?v=VO4IGFayJWo">Immutable Data Structures are Thread Safe</a></li>
  <li><a href="https://www.youtube.com/watch?v=uFxWg3cVMRs">How to Make an Object Immutable in Java</a></li>
  <li><a href="https://immutables.github.io/">Immutability Library Java</a></li>
  <li><a href="https://github.com/google/guava/wiki/ImmutableCollectionsExplained">Google Guava Immutable Data Structures</a></li>
  <li><a href="https://docs.oracle.com/javase/tutorial/essential/concurrency/imstrat.html">A Strategy for Defining Immutable Objects</a></li>
  <li><a href="https://www.youtube.com/watch?v=ST3wU79nwS8">Mutability Detector In Action</a></li>
</ul>


  </div>
  <!-- https://david.elbe.me/jekyll/2015/06/20/how-to-link-to-next-and-previous-post-with-jekyll.html -->

<div class="PageNavigation">
    
      <a class="prev" href="/perfection/">« Perfection isn't an attainable goal. We are always a step closer to it.</a>
    
    
      <a class="next" href="/team-knowing-whom-to-contact/">Increase collaboration by knowing whom to contact »</a>
    
  </div>

<style>
    .PageNavigation {
  font-size: 14px;
  display: block;
  width: auto;
  overflow: hidden;
}

.PageNavigation a {
  display: block;
  width: 50%;
  float: left;
  margin: 1em 0;
}

.PageNavigation .next {
  text-align: right;
}
</style>
<!-- from https://github.com/utterance/utterances -->
<script src="https://utteranc.es/client.js" repo="ankschoubey/blog" issue-term="title" label="blogpost-comment" theme="github-light" crossorigin="anonymous" async>
</script>

  <div id="disqus_thread"></div>
  <script>
    var disqus_config = function () {
      this.page.url = 'www.ankushchoubey.com/immutable-objects/';
      this.page.identifier = 'www.ankushchoubey.com/immutable-objects/';
    };
    (function() {
      var d = document, s = d.createElement('script');
      s.src = 'https://ankushchoubey.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a>
</noscript>
<a class="u-url" href="/immutable-objects/" hidden></a>
</article>
      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>Full Stack Developer - Cloud/Microservices</p>
      </div>
    </div>

    <div class="social-links">
<ul class="social-media-list">
<li>
  <a rel="me" href="https://github.com/ankschoubey" target="_blank" title="github">
    <svg class="svg-icon grey">
      <use xlink:href="/assets/minima-social-icons.svg#github"></use>
    </svg>
  </a>
</li>
<li>
  <a rel="me" href="https://twitter.com/ankschoubey" target="_blank" title="twitter">
    <svg class="svg-icon grey">
      <use xlink:href="/assets/minima-social-icons.svg#twitter"></use>
    </svg>
  </a>
</li>
</ul>
</div>

  </div>

</footer>
</body>

</html>
