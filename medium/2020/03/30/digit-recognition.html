<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Digit Recognition | Ankush</title>
<meta name="generator" content="Jekyll v4.0.0" />
<meta property="og:title" content="Digit Recognition" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Kaggle Getting Started" />
<meta property="og:description" content="Kaggle Getting Started" />
<link rel="canonical" href="www.ankushchoubey.com/medium/2020/03/30/digit-recognition.html" />
<meta property="og:url" content="www.ankushchoubey.com/medium/2020/03/30/digit-recognition.html" />
<meta property="og:site_name" content="Ankush" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-03-30T00:00:00-05:00" />
<script type="application/ld+json">
{"description":"Kaggle Getting Started","@type":"BlogPosting","headline":"Digit Recognition","dateModified":"2020-03-30T00:00:00-05:00","datePublished":"2020-03-30T00:00:00-05:00","mainEntityOfPage":{"@type":"WebPage","@id":"www.ankushchoubey.com/medium/2020/03/30/digit-recognition.html"},"url":"www.ankushchoubey.com/medium/2020/03/30/digit-recognition.html","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="www.ankushchoubey.com/feed.xml" title="Ankush" /><!-- the google_analytics_id gets auto inserted from the config file -->



<script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-35993343-1','auto');ga('require','displayfeatures');ga('send','pageview');</script>

<link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Digit Recognition | Ankush</title>
<meta name="generator" content="Jekyll v4.0.0" />
<meta property="og:title" content="Digit Recognition" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Kaggle Getting Started" />
<meta property="og:description" content="Kaggle Getting Started" />
<link rel="canonical" href="www.ankushchoubey.com/medium/2020/03/30/digit-recognition.html" />
<meta property="og:url" content="www.ankushchoubey.com/medium/2020/03/30/digit-recognition.html" />
<meta property="og:site_name" content="Ankush" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-03-30T00:00:00-05:00" />
<script type="application/ld+json">
{"description":"Kaggle Getting Started","@type":"BlogPosting","headline":"Digit Recognition","dateModified":"2020-03-30T00:00:00-05:00","datePublished":"2020-03-30T00:00:00-05:00","mainEntityOfPage":{"@type":"WebPage","@id":"www.ankushchoubey.com/medium/2020/03/30/digit-recognition.html"},"url":"www.ankushchoubey.com/medium/2020/03/30/digit-recognition.html","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

<link href="https://unpkg.com/@primer/css/dist/primer.css" rel="stylesheet" />
<link rel="stylesheet" href="//use.fontawesome.com/releases/v5.0.7/css/all.css"><link type="application/atom+xml" rel="alternate" href="www.ankushchoubey.com/feed.xml" title="Ankush" /><!-- the google_analytics_id gets auto inserted from the config file -->



<script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-35993343-1','auto');ga('require','displayfeatures');ga('send','pageview');</script>


    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css" integrity="sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/+DiW/UqRcLbRjq" crossorigin="anonymous">
    <script type="text/javascript" async src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML"> </script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js" integrity="sha384-y23I5Q6l+B6vatafAwxRu/0oK/79VlbSz7Q9aiSZUvyWYIYsd+qj+o24G5ZU2zJz" crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js" integrity="sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI" crossorigin="anonymous"></script>
    <script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement( document.body, {
        delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "[%", right: "%]", display: true},
            {left: "$", right: "$", display: false}
        ]}
        );
    });
    </script>


<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head><body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Ankush</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/search/">ðŸ”Ž</a><a class="page-link" href="/categories/">ðŸ—„</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Digit Recognition</h1><p class="post-meta post-meta-title"><time class="dt-published" datetime="2020-03-30T00:00:00-05:00" itemprop="datePublished">
        Mar 30, 2020
      </time>
       â€¢ <span class="read-time" title="Estimated read time">
    
    
      6 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/categories/#Medium">Medium</a>
        
      
      </p>
    

    </header>

  <div class="post-content e-content" itemprop="articleBody">
    <ul class="section-nav">
<li class="toc-entry toc-h4"><a href="#kaggle-getting-started">Kaggle Getting Started</a></li>
<li class="toc-entry toc-h4"><a href="#how-to-read-this">How to read this?</a></li>
<li class="toc-entry toc-h4"><a href="#commit-version-2-getting-input-and-generating-submission-file">Commit Version 2: Getting Input and Generating Submission File</a></li>
<li class="toc-entry toc-h4"><a href="#commit-version-3-improvements">Commit Version 3: Improvements</a></li>
<li class="toc-entry toc-h4"><a href="#proper-accuracy">Proper Accuracy</a></li>
<li class="toc-entry toc-h4"><a href="#graph">Graph</a></li>
<li class="toc-entry toc-h4"><a href="#data-normalization">Data Normalization</a></li>
<li class="toc-entry toc-h4"><a href="#commit-6-convnet-and-gpu">Commit 6: ConvNet, and GPU</a></li>
<li class="toc-entry toc-h4"><a href="#convnet">ConvNet</a></li>
<li class="toc-entry toc-h4"><a href="#gpu">GPU</a></li>
<li class="toc-entry toc-h4"><a href="#commit-7-improvement">Commit 7: Improvement</a></li>
</ul><h4 id="kaggle-getting-started">
<a class="anchor" href="#kaggle-getting-started" aria-hidden="true"><span class="octicon octicon-link"></span></a>Kaggle Getting Started</h4>

<p>P<a href="https://medium.com/p/c06251780b">re-requisites</a></p>

<h4 id="how-to-read-this">
<a class="anchor" href="#how-to-read-this" aria-hidden="true"><span class="octicon octicon-link"></span></a>How to read this?</h4>

<ol>
  <li>
    <p>Open each commit notebook then read the explanations.</p>
  </li>
  <li>
    <p>Just run each notebook top to bottom.</p>
  </li>
  <li>
    <p>Try to understand each line.</p>
  </li>
  <li>
    <p>If you find yourself stuck at statements, explore the variable involved.</p>
  </li>
  <li>
    <p>Still, <strong>stuck</strong>?? <strong>highlight the explanation and comment</strong>. I will get back to your query.</p>
  </li>
</ol>

<h4 id="commit-version-2-getting-input-and-generating-submission-file">
<a class="anchor" href="#commit-version-2-getting-input-and-generating-submission-file" aria-hidden="true"><span class="octicon octicon-link"></span></a><a href="https://www.kaggle.com/ankschoubey/20200324-pytorch-mnist?scriptVersionId=30660257">Commit Version 2</a>: Getting Input and Generating Submission File</h4>

<ul>
  <li>
    <p><em>Day 1</em></p>
  </li>
  <li>
    <p>Score â€” 0.43</p>
  </li>
  <li>
    <p>Time invested â€” about an hour</p>
  </li>
</ul>

<p>My goal for any first commit is always to get input, pass it through a NN and generate a submittable output.</p>

<p><strong>Read the data</strong></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>train_df = pd.read_csv('/kaggle/input/digit-recognizer/train.csv')
</code></pre></div></div>

<p><strong>Training/testing</strong></p>

<p>I needed a way to separate features and labels.</p>

<p>So the easiest way was to not select a column named â€˜labelâ€™.</p>

<p><em>test_df</em> does not contain a label column</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>train_df.loc[:, train_df.columns != 'label']
type(test_df.get('label')) == None
#false
</code></pre></div></div>

<p><strong>Dataset</strong></p>

<p>Returns features and labels if â€˜train=Trueâ€™. else it returns just features</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>class **MnistDataset**(Dataset):
    def __init__(self, df, train=True):
        #convert df to self.X and self.y using above

    def __len__(self):
        return self.X.shape[0]

    def __getitem__(self, i):
        if self.train: return self.X[i], self.y[i]
        return self.X[i]
</code></pre></div></div>

<p>Observation: Even if I donâ€™t explicitly mention Tensor, NumPy is converted to tensor.</p>

<p><strong>Creating DataLoader</strong></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bs = 64
ds = MnistDataset(train_df)
dl = DataLoader(ds, bs)
</code></pre></div></div>

<p><strong>Checking if DataLoader returns the right output</strong></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>images, labels = next(iter(dl))
images.shape, labels.shape
</code></pre></div></div>

<p><strong>Creating a vanilla Neural Network</strong></p>

<p>I created a dumb NN just so that I can pass data through it and get output in the desired shape.</p>

<p>The details donâ€™t matter much. This will be replaced by a CNN later.</p>

<p><strong>Preparing the training loop</strong></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>epochs = 10
loss_fn = nn.CrossEntropyLoss()

import torch.optim as optim
o = optim.Adam(net.parameters())
</code></pre></div></div>

<p><strong>Creating the training loop</strong></p>

<p>Here are the 4 steps to create a basic training loop</p>

<ol>
  <li><strong>Loop epoch number of times</strong></li>
</ol>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>for i **in** range(epochs):
    ...
</code></pre></div></div>

<ol>
  <li>Inside the epoch loop, <strong>loop through data loader</strong> (dl)</li>
</ol>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>for images, labels **in** dl:
    ...
</code></pre></div></div>

<ol>
  <li>Inside the data loader loop,</li>
</ol>

<ul>
  <li>
    <p><strong>zero</strong> <strong>grad optimizer</strong> <strong>before passing pushing data</strong> into NN.</p>
  </li>
  <li>
    <p>Take an <strong>optimizer step after pushing data</strong> through NN.</p>
  </li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>o.zero_grad()
...
o.step()
</code></pre></div></div>

<ol>
  <li>Between optimizer zero_grad and optimizer step, <strong>pass data through the NN, compute loss and gradients.</strong>
</li>
</ol>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>out = net(images.float())
loss = loss_fn(out.float(), labels.long())
loss.backward()
</code></pre></div></div>

<p><strong>Generating output</strong></p>

<p>A similar step as above has been taken to generate test_dl and the testing loop.</p>

<p>The only difference,</p>

<ul>
  <li>
    <p>test_dl has â€˜train=trueâ€™. Dataset will only return features and not labels.</p>
  </li>
  <li>
    <p>code to not calculate gradients since we are not training.</p>
  </li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>with torch.no_grad():
    ...
</code></pre></div></div>

<ul>
  <li>
    <p>The output is in the form of numbers from 0â€¦9.</p>
  </li>
  <li>
    <p>Our output is a column <strong><em>(dim=1)</em></strong> array of length 10 with probability.</p>
  </li>
  <li>
    <p>The maximum of this array is our output.</p>
  </li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>out.argmax(dim=1)
</code></pre></div></div>

<p>We store these outputs in an <strong>outputs</strong> python list.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>test_df.shape, sample_df.shape
# Out[17]: ((28000, 784), (28000, 2))
</code></pre></div></div>

<ul>
  <li>
    <p>I realized that sample submission and output df have the same length.</p>
  </li>
  <li>
    <p>I just need to add â€˜Labelâ€™ column to the submission data frame and save it in CSV form.</p>
  </li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sample_df['Label'] = outputs
sample_df.to_csv('submission.csv', index=False)
</code></pre></div></div>

<p><strong>index=False</strong> removed the default pandas index when saving</p>

<h4 id="commit-version-3-improvements">
<a class="anchor" href="#commit-version-3-improvements" aria-hidden="true"><span class="octicon octicon-link"></span></a><a href="https://www.kaggle.com/ankschoubey/20200324-pytorch-mnist?scriptVersionId=30753580">Commit Version 3</a>: Improvements</h4>

<p><em>Changes</em>: Proper Accuracy, Graph, and Data Normalization</p>

<ul>
  <li>
    <p><em>Day 4</em></p>
  </li>
  <li>
    <p>Score â€” 0.96</p>
  </li>
  <li>
    <p>Time invested â€” about an hour</p>
  </li>
</ul>

<h4 id="proper-accuracy">
<a class="anchor" href="#proper-accuracy" aria-hidden="true"><span class="octicon octicon-link"></span></a>Proper Accuracy</h4>

<p>Accuracy should always be calculated on the validation set.</p>

<p><strong><em>Creating a separate validation set</em></strong></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>val_len = int(len(ds)*0.01) # 0.01 percent of data
train_len = len(ds) â€” val_len # all other are in training

from torch.utils.data import random_split

train_ds, val_ds = random_split(ds, [train_len, val_len])
</code></pre></div></div>

<p>Likewise, 2 data loaders are created.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bs = 64
train_dl = DataLoader(train_ds, bs)
val_dl = DataLoader(val_ds, bs)
</code></pre></div></div>

<p><strong><em>Changes in the training loop</em></strong></p>

<p>A separate list called accuracies in created to store the accuracy of an epoch.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>...
with torch.no_grad():
        accuracy = 0
        for images, labels in val_dl:
            out = net(images.float())
            accuracy+=(out.argmax(dim=1) == labels).sum().item()
        accuracies.append(accuracy/len(val_ds) * 100)
</code></pre></div></div>

<h4 id="graph">
<a class="anchor" href="#graph" aria-hidden="true"><span class="octicon octicon-link"></span></a>Graph</h4>

<p>Since the accuracy of each epoch was stored in a separate accuracies list, creating a graph was easy.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>import matplotlib.pyplot as plt

plt.plot(range(epochs), accuracies)
</code></pre></div></div>

<h4 id="data-normalization">
<a class="anchor" href="#data-normalization" aria-hidden="true"><span class="octicon octicon-link"></span></a>Data Normalization</h4>

<p>After plotting the graph, I realized accuracy was 43% which is the same as the score of commit 2.</p>

<p>The easiest thing to do was to normalize the data.</p>

<p>Since MNIST images are in the range of 1â€¦250 the easiest thing to do was to divide by 250 which would result in a range of 0â€¦1.</p>

<p>Ideally, the range should be around 0 so an even better approach would be</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>image = image/250â€“0.5
</code></pre></div></div>

<p>this would result in a range between -0.5â€¦+0.5.</p>

<p>Later we would use <code class="highlighter-rouge">torchvision.transforms.Normalize</code>(<em>mean</em>, <em>std</em>, <em>inplace=False</em>) which generates unique normalization value for each dataset</p>

<h4 id="commit-6-convnet-and-gpu">
<a class="anchor" href="#commit-6-convnet-and-gpu" aria-hidden="true"><span class="octicon octicon-link"></span></a><a href="https://www.kaggle.com/ankschoubey/20200326-pytorch-mnist?scriptVersionId=30896320">Commit 6</a>: ConvNet, and GPU</h4>

<ul>
  <li>
    <p>Day 6</p>
  </li>
  <li>
    <p>Score â€” 0.97</p>
  </li>
  <li>
    <p>Time invested â€” about 2 hours (lots of googling and reading docs) + 1 hours fixes bugs</p>
  </li>
</ul>

<h4 id="convnet">
<a class="anchor" href="#convnet" aria-hidden="true"><span class="octicon octicon-link"></span></a>ConvNet</h4>

<p>Convolutional Neural Networks are ideal images.</p>

<p><strong><em>ResNet</em></strong></p>

<p>ResNet 34 is my goto ConvNet but since MNIST is so easy, I went with ResNet 18.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>import torchvision.models as models
resnet18 = models.resnet18(pretrained=True)
resnet18.fc #print fully connected network
</code></pre></div></div>

<p>ResNet is designed to output 1000 classes. But our output is from 0â€¦9 aka 10 classes.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>lin_in = resnet18.fc.in_features

import torch.nn as nn

resnet18.fc = nn.Sequential(
    nn.Linear(lin_in, 10),
    nn.Softmax(dim=1)
)
</code></pre></div></div>

<p><strong><em>Convert Grayscale to RGB image</em></strong></p>

<p>ResNet expects RGB images. MNIST is grayscale.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>`img = img.view(3, 28, 28).expand(3, 28, 28)`
</code></pre></div></div>

<p>This <a href="https://discuss.pytorch.org/t/grayscale-to-rgb-transform/18315/7">grayscale to the RGB</a> line is added to our Dataset class.</p>

<p><strong><em>Normalization</em></strong></p>

<p>When using an existing model, we need to use the same normalization values as that model. The <a href="#https://pytorch.org/docs/stable/torchvision/models.html">docs mention the normalization value</a>.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>import  torchvision.transforms as transforms
normalize = transforms.Normalize(mean=[0.485, 0.456, 0.406],
                                 std=[0.229, 0.224, 0.225])
</code></pre></div></div>

<p>The <strong>init</strong> and <strong>getitem</strong> dataset class have been modified to use this transformation.</p>

<p>Modifications have also been made to test_ds.</p>

<h4 id="gpu">
<a class="anchor" href="#gpu" aria-hidden="true"><span class="octicon octicon-link"></span></a>GPU</h4>

<p>One I started the training loop, I realized it suddenly became too slow.</p>

<p>GPU is needed!</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>device = torch.device('cuda:0') if torch.cuda.is_available() else 'cpu'
</code></pre></div></div>

<p>If the GPU is on, the device will be <em>cuda</em>.</p>

<p>The neural network and the data in training, validation and texting loop have been changed to run on GPU.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>net = net.to(device)
...

images, labels = images.to(device,dtype=torch.float), labels.to(device)
</code></pre></div></div>

<p>And since we are on GPU we can increase our batch size from 64 to much higher.</p>

<p>I experimented with a few sizes from 320â€¦640 and kept an eye on GPU utilization and settled for 512.</p>

<p><img src="/images/2020-03-30-digit-recognition/1.png" alt="CPU and GPU Utilization. Also, see the number of tabs open."></p>

<p>I did the same for <a href="https://discuss.pytorch.org/t/guidelines-for-assigning-num-workers-to-dataloader/813/2">num_worker</a> which specifies the number of threads to load a batch. This is CPU stuff.</p>

<p>Along with monitoring GPU and CPU usage, I modified training_loop to show the <a href="https://stackoverflow.com/a/36423341">amount of time taken to complete each epoch</a>.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bs = 512
num_workers = 2
train_dl = DataLoader(train_ds, bs, num_workers=num_workers)
val_dl = DataLoader(val_ds, bs, num_workers=num_workers)
</code></pre></div></div>

<p>This resulted in 7 seconds per epoch.</p>

<p>For testing, the batch_size can be much higher since we donâ€™t have to back prop.</p>

<h4 id="commit-7-improvement">
<a class="anchor" href="#commit-7-improvement" aria-hidden="true"><span class="octicon octicon-link"></span></a><a href="https://www.kaggle.com/ankschoubey/20200326-pytorch-mnist/output?scriptVersionId=31120757">Commit 7</a>: Improvement</h4>

<ul>
  <li>
    <p>Day 8</p>
  </li>
  <li>
    <p>Score â€” 0.97</p>
  </li>
  <li>
    <p>Time invested â€” about 30 minutes</p>
  </li>
</ul>

<p>I learned that you donâ€™t need <a href="https://discuss.pytorch.org/t/vgg-output-layer-no-softmax/9273">nn.Softmax if you are using nn.CrossEntropyLoss</a>.</p>

<p>nn.CrossEntropyLoss has nn.Softmax built-in and the results of softmax are not used during back-prop. So it can be safely removed.</p>

<p>Now FC is this:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>lin_in = resnet18.fc.in_features

import torch.nn as nn

resnet18.fc = nn.Sequential(
    nn.Linear(lin_in, 10)
)
</code></pre></div></div>

  </div><!-- from https://github.com/utterance/utterances -->
<script src="https://utteranc.es/client.js"
        repo="ankschoubey/blog"
        issue-term="title"
        label="blogpost-comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script><a class="u-url" href="/medium/2020/03/30/digit-recognition.html" hidden></a>
</article>
      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p></p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/ankschoubey" title="ankschoubey"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg></a></li><li><a rel="me" href="https://twitter.com/ankschoubey" title="ankschoubey"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>
